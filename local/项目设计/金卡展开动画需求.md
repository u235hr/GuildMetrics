# 完整动画逻辑需求文档

## 整体动画系统设计

### 1. 动画系统架构
整个动画系统包含三个主要部分：金卡展开动画、三张卡片wiggle动画、以及它们之间的协调机制。系统采用事件驱动的方式，确保动画序列的精确控制和流畅执行。

### 1.1 设计理念转变
- **原始demo**: 基于用户交互的hover效果，鼠标悬停时触发3D倾斜和缩放
- **项目目标**: 打造纯自动展示的动画系统，无需用户交互，专注于视觉效果呈现
- **hover替代方案**: 用自动wiggle动画替代原本的hover交互，营造更生动的展示效果,取消缩放效果

### 2. 金卡展开动画流程

#### 2.1 初始状态
- 三张卡片（金、银、铜）处于静态状态
- 页面加载完成后，金卡自动开始展开动画
- 银卡和铜卡仅作为展示，不参与交互
- 所有卡片在wiggle开始前保持静态，无鼠标交互

#### 2.2 自动展开触发
页面加载完成后，金卡自动触发以下动画序列：
1. **自动状态切换**: 金卡展开状态自动切换
2. **金卡位移动画**: 金卡向上移动2vh，为展开让出空间
3. **outline-page动画**: 300ms延迟后开始展开动画
4. **detail-page显示**: 在outline-page动画进行到一半时开始显示
5. **detail-page动画**: 执行slide-in-bottom滑入动画，持续1秒
6. **动画完成检测**: 监听detail-page的动画结束事件

#### 2.3 动画时序控制
- **页面加载**: 组件挂载后自动开始动画序列
- **金卡位移**: 立即开始向上移动2vh，持续0.5秒
- **outline-page展开**: 300ms延迟开始，与金卡位移重叠
- **detail-page显示**: 在outline-page动画进行到一半时开始
- **wiggle触发**: detail-page动画真正完成后立即触发（基于动画事件，非固定时间）
- **wiggle持续**: 动画完成后持续wiggle，直到页面卸载

### 3. Wiggle动画系统

#### 3.1 Wiggle触发机制
- **触发条件**: detail-page动画完成事件
- **触发方式**: 金卡设置自己的wiggle状态 + 发送全局事件
- **同步机制**: 银卡和铜卡监听全局事件，确保三张卡片同时开始wiggle

#### 3.2 Wiggle动画特性
- **动画类型**: 3D轻微摆动效果
- **摆动幅度**: X轴15px，Y轴10px的轻微摆动
- **摆动频率**: 20fps（50ms间隔）
- **摆动强度**: 为正常鼠标旋转强度的30%
- **持续时间**: 持续进行，直到页面卸载

#### 3.3 Wiggle控制逻辑
- **金卡**: 通过自己的startWiggle状态控制
- **银卡/铜卡**: 通过监听goldCardExpanded全局事件接收wiggle信号
- **无鼠标交互**: 整个动画过程中不响应鼠标交互
- **状态重置**: 页面卸载时清理所有动画状态

### 4. 动画控制机制

#### 4.1 从hover到自动wiggle的转变
- **原始hover效果**: 鼠标悬停时触发3D倾斜和缩放，离开时恢复
- **新的自动wiggle**: 动画完成后自动开始持续的3D摆动效果
- **交互方式改变**: 从用户主动触发改为系统自动触发
- **视觉效果提升**: wiggle效果比hover更持久，营造更生动的展示氛围

#### 4.2 纯自动动画
- **无用户交互**: 整个动画过程完全自动化，不响应鼠标操作
- **自动wiggle**: 动画完成后自动开始wiggle效果
- **持续运行**: wiggle效果持续进行，直到页面卸载

#### 4.3 动画状态管理
- 使用条件判断确保动画状态的一致性
- 动画停止时立即重置旋转值，确保状态一致性
- 通过事件驱动机制协调所有动画状态

### 5. 状态管理系统

#### 5.1 核心状态变量
- **isExpanded**: 控制金卡整体展开状态
- **showDetailPage**: 控制detail-page的显示状态
- **startWiggle**: 控制wiggle动画开关
- **全局startWiggle**: 协调三张卡片的wiggle状态

#### 5.2 事件通信机制
- **goldCardExpanded**: 金卡展开完成，触发wiggle开始
- **组件挂载**: 页面加载完成后自动触发展开动画
- **事件监听**: Top3Container监听全局事件，统一管理wiggle状态

### 6. 动画性能优化

#### 6.1 无限递归避免
- 移除motion values从useEffect依赖数组
- 使用稳定的引用避免不必要的重新渲染
- 确保wiggle动画不会触发无限循环

#### 6.2 动画流畅性
- 使用requestAnimationFrame优化动画帧率
- 合理的动画间隔（50ms）平衡性能和流畅度
- 适当的缓动函数确保自然的动画效果

### 7. 用户体验设计

#### 7.1 视觉反馈
- 页面加载完成后立即开始动画，提供清晰的视觉反馈
- 动画序列流畅自然，各阶段过渡平滑
- wiggle效果营造生动的视觉体验

#### 7.2 展示体验
- 整个过程完全自动化，无需用户任何操作
- 页面加载后自动展示完整的动画效果
- 动画状态清晰，用户能明确感知当前状态
- 纯展示性质，专注于视觉效果呈现
- 用自动wiggle替代原本的hover交互，提供更持久的视觉吸引力

#### 7.3 性能体验
- 动画流畅不卡顿，响应及时
- 合理的资源使用，避免性能问题
- 状态管理清晰，避免意外行为

### 8. 动画加载和性能保证

#### 8.1 资源预加载机制
- **图片预加载**: 确保所有头像图片在动画开始前完全加载完成
- **字体预加载**: 使用font-display: swap确保字体快速加载
- **CSS预加载**: 关键动画样式优先加载，避免样式闪烁
- **组件预渲染**: 在动画开始前完成所有组件的初始渲染

#### 8.2 动画启动条件检查
- **DOM就绪**: 确保所有DOM元素已完全渲染
- **资源就绪**: 检查关键资源（图片、字体）是否加载完成
- **布局稳定**: 等待浏览器完成初始布局计算
- **性能就绪**: 确保页面性能指标达到可接受水平

#### 8.3 渐进式动画启动
- **分阶段启动**: 先启动简单动画，再启动复杂动画
- **性能监控**: 实时监控帧率，必要时降低动画复杂度
- **降级策略**: 在低性能设备上使用简化版动画
- **用户控制**: 提供动画开关，让用户选择是否启用

#### 8.4 动画流畅性保证
- **requestAnimationFrame**: 使用RAF确保动画与浏览器刷新率同步
- **GPU加速**: 使用transform和opacity等GPU加速属性
- **避免重排重绘**: 避免在动画中修改会触发重排的属性
- **内存管理**: 及时清理动画定时器和事件监听器

### 9. 技术实现要点

#### 9.1 自动触发机制
页面加载完成后，通过useEffect钩子自动触发展开动画序列，但需要先进行资源就绪检查。金卡首先向上移动2vh为展开让出空间，然后开始outline-page和detail-page的展开动画。监听detail-page元素的动画结束事件，只有当动画名称为slide-in-bottom且当前处于显示状态时才触发wiggle信号。

#### 9.2 事件驱动架构
使用React事件系统和自定义全局事件实现组件间通信，确保动画状态的精确控制和同步。组件挂载时自动开始动画流程，但需要确保所有依赖资源已就绪。

#### 9.3 状态一致性
通过统一的状态管理和事件机制，确保三张卡片的wiggle状态始终保持一致，避免不同步的问题。动画完成后持续运行，直到页面卸载。

#### 9.4 性能优化策略
- **懒加载**: 非关键资源延迟加载
- **代码分割**: 动画相关代码按需加载
- **缓存策略**: 合理使用浏览器缓存
- **压缩优化**: 图片和代码压缩，减少加载时间

### 10. Bug预防和代码质量保证

#### 10.1 无限递归预防
- **useEffect依赖数组**: 避免将motion values（rotateX, rotateY）放入依赖数组
- **状态更新检查**: 确保状态更新不会触发无限循环
- **事件监听清理**: 及时清理事件监听器，避免内存泄漏
- **定时器管理**: 确保setInterval在组件卸载时被正确清理

#### 10.2 动画状态冲突预防
- **单一状态控制**: 确保同一时间只有一种动画效果生效
- **状态重置机制**: 动画停止时立即重置所有相关状态
- **条件判断**: 使用严格的条件判断避免意外触发
- **事件去重**: 避免重复触发相同的事件

#### 10.3 内存泄漏预防
- **定时器清理**: 所有setInterval和setTimeout都要在useEffect的cleanup中清理
- **事件监听清理**: 全局事件监听器要在组件卸载时移除
- **引用清理**: 及时清理useRef和DOM引用
- **状态重置**: 组件卸载时重置所有动画状态

#### 10.4 性能问题预防
- **避免频繁重渲染**: 使用useCallback和useMemo优化性能
- **GPU加速**: 优先使用transform和opacity等GPU加速属性
- **避免同步操作**: 避免在动画循环中执行同步DOM操作
- **帧率控制**: 合理控制动画频率，避免过度消耗CPU

#### 10.5 边界情况处理
- **组件卸载**: 确保动画在组件卸载时能正确停止
- **快速切换**: 处理快速连续的状态切换
- **资源加载失败**: 处理图片等资源加载失败的情况
- **浏览器兼容性**: 确保在不同浏览器中都能正常工作

#### 10.6 调试和监控
- **控制台日志**: 添加关键节点的调试日志
- **性能监控**: 监控动画帧率和内存使用
- **错误边界**: 使用React错误边界捕获动画相关错误
- **状态追踪**: 记录关键状态变化，便于调试,不允许破坏原有动画,不允许用强制触发wiggle替代本来的要求
